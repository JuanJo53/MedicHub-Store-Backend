<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bo.ucb.edu.medichub.dao.ProductPurchaseDao">
    <insert id="createProductPurchase" parameterType="bo.ucb.edu.medichub.model.ProductPurchase">
        INSERT INTO product_purchase VALUES (
            null, #{productId}, #{purchaseId}, #{quantity},
            1, #{transaction.txId}, #{transaction.txHost}, #{transaction.txUserId}, #{transaction.txDate}
        )
    </insert>

    <select id="getStockByProductId" resultType="java.lang.Integer">
        select stock
        from product
        where product_id = #{productId}
          and status = 1
    </select>

    <update id="updateStock" parameterType="bo.ucb.edu.medichub.model.Product">
        UPDATE product set
            stock = #{stock}
        WHERE
            product_id=#{productId} and status = 1
    </update>


    <select id="getListProductPurchase" resultMap="productPurchaseListMap">
        SELECT
        c.product_id as productId,
        d.name as brandName,
        c.name as name,
        b.quantity as quantity,
        c.price as price,
        c.type as type,
        c.dose as dose,
        c.description as description,
        c.picture as picture

        FROM product_purchase b, product c, brand d
        WHERE
        d.brand_id = c.brand_id  and
        b.product_id = c.product_id and
        b.purchase_id = #{purchaseId} and
        b.status = 1
        ORDER BY c.name DESC
    </select>
    <resultMap id="productPurchaseListMap" type="bo.ucb.edu.medichub.dto.ProductListResponse">
        <result column="productId" property="productId"/>
        <result column="brandName" property="brandName"/>
        <result column="name" property="name"/>
        <result column="quantity" property="quantity"/>
        <result column="price" property="price"/>
        <result column="type" property="type"/>
        <result column="dose" property="dose"/>
        <result column="description" property="description"/>
        <result column="picture" property="picture"/>
    </resultMap>



    <select id="getProductSubsidiaryReportAsc" resultMap="productSubsidiaryReportListMap">
        SELECT
	        b.product_id as productId,
	        SUM(c.quantity) as quantity,
	        b.name as name,
	        b.price as price,
	        b.stock as stock,
	        b.picture as picture
        FROM subsidiary a, product b, product_purchase c, purchase d
        WHERE
    	    a.subsidiary_id=b.subsidiary_id
            and b.product_id=c.product_id
            and d.purchase_id = c.product_id
            and a.subsidiary_id=#{subsidiaryId}
        GROUP BY b.product_id
        ORDER BY SUM(c.quantity) ASC
        LIMIT #{size} OFFSET #{page}
    </select>

    <select id="getProductSubsidiaryReportDesc" resultMap="productSubsidiaryReportListMap">
        SELECT
	        b.product_id as productId,
	        SUM(c.quantity) as quantity,
	        b.name as name,
	        b.price as price,
	        b.stock as stock,
	        b.picture as picture
        FROM subsidiary a, product b, product_purchase c, purchase d
        WHERE
    	    a.subsidiary_id=b.subsidiary_id
            and b.product_id=c.product_id
            and d.purchase_id = c.product_id
            and a.subsidiary_id=#{subsidiaryId}
        GROUP BY b.product_id
        ORDER BY SUM(c.quantity) DESC
        LIMIT #{size} OFFSET #{page}

    </select>

    <select id="getProductSubsidiaryReport" resultMap="productSubsidiaryReportListMap">
        SELECT
	        b.product_id as productId,
	        SUM(c.quantity) as quantity,
	        b.name as name,
	        b.price as price,
	        b.stock as stock,
	        b.picture as picture
        FROM subsidiary a, product b, product_purchase c, purchase d
        WHERE
    	    a.subsidiary_id=b.subsidiary_id
            and b.product_id=c.product_id
            and d.purchase_id = c.product_id
            and a.subsidiary_id=#{subsidiaryId}
        GROUP BY b.product_id
        ORDER BY SUM(c.quantity) DESC

    </select>

    <resultMap id="productSubsidiaryReportListMap" type="bo.ucb.edu.medichub.dto.ProductReserveRepRequest">
        <result column="productId" property="productId"/>
        <result column="quantity" property="quantity"/>
        <result column="name" property="name"/>
        <result column="price" property="price"/>
        <result column="stock" property="stock"/>
        <result column="picture" property="picture"/>
    </resultMap>
</mapper>
