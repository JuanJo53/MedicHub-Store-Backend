<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bo.ucb.edu.medichub.dao.ProductReserveDao">
    <insert id="createProductReserve" parameterType="bo.ucb.edu.medichub.model.ProductReserve">
        INSERT INTO product_reserve VALUES (
            null, #{productId}, #{reserveId}, #{quantity},
            1, #{transaction.txId}, #{transaction.txHost}, #{transaction.txUserId}, #{transaction.txDate}
        )
    </insert>

    <update id="updateProductReserve" parameterType="bo.ucb.edu.medichub.model.ProductReserve">
        UPDATE product_reserve set
            quantity=#{quantity},
            tx_id=#{transaction.txId},
            tx_host=#{transaction.txHost},
            tx_user_id=#{transaction.txUserId},
            tx_date=#{transaction.txDate}
        WHERE
            product_reserve_id=#{productId}
        and reserve_id=#{reserveId}
        and status=1
    </update>

    <select id="getListProductReserve" resultMap="productReserveListMap">
        SELECT
        c.product_id as productId,
        c.name as name,
        c.price as price,
        b.quantity as quantity
        FROM product_reserve b, product c
        WHERE
        b.product_id = c.product_id and
        b.reserve_id = #{reserveId} and
        b.status = 1
        ORDER BY c.name DESC
    </select>
    <resultMap id="productReserveListMap" type="bo.ucb.edu.medichub.dto.ProductReserveRequest">
        <result column="productId" property="productId"/>
        <result column="name" property="name"/>
        <result column="price" property="price"/>
        <result column="quantity" property="quantity"/>
    </resultMap>


    <select id="productListClient" resultMap="productListClientMap">
        SELECT
        d.product_reserve_id as productId,
        b.name as brandName,
        a.name as name,
        d.quantity as quantity,
        a.price as price,
        a.type as type,
        a.dose as dose,
        a.description as description,
        a.picture as picture
        FROM product a, brand b, product_reserve d, reserve e
        WHERE
        a.brand_id = b.brand_id  and
        e.reserve_id = d.reserve_id and
        a.product_id = d.product_id and
        e.client_id=#{clientId} and
        e.status_reserve = #{state}
        and d.status = 1
        ORDER BY a.name DESC
        LIMIT #{size} OFFSET #{page}
    </select>
    <resultMap id="productListClientMap" type="bo.ucb.edu.medichub.dto.ProductListResponse">
        <result column="productId" property="productId"/>
        <result column="brandName" property="brandName"/>
        <result column="name" property="name"/>
        <result column="quantity" property="quantity"/>
        <result column="price" property="price"/>
        <result column="type" property="type"/>
        <result column="dose" property="dose"/>
        <result column="description" property="description"/>
        <result column="picture" property="picture"/>
    </resultMap>


    <select id="quantityProductReserve" resultType="java.lang.Integer">
        SELECT
            SUM(d.quantity) as quantity
        FROM product_reserve d, reserve e
        WHERE
            e.client_id=#{clientId} and
            e.status_reserve = #{state} and
            e.reserve_id = d.reserve_id and
            d.status = 1
    </select>

    <select id="reserveProductReserve" resultMap="productReserveTotalMap">
        SELECT
        c.price as price,
        b.quantity as quantity
        FROM product_reserve b, product c, reserve e
        WHERE
        <if test="name!='' ">
            a.name = #{name} and
        </if>
        b.product_id = c.product_id and
        e.reserve_id = b.reserve_id and
        e.client_id=#{clientId} and
        e.reserve_id=#{reserveId} and
        b.status = 1
    </select>
    <resultMap id="productReserveTotalMap" type="bo.ucb.edu.medichub.dto.ProductReserveRequest">
        <result column="price" property="price"/>
        <result column="quantity" property="quantity"/>
    </resultMap>

    <select id="getProductReserveIfExists" resultType="java.lang.Integer">
        SELECT
            quantity
        FROM product_reserve
        WHERE
            product_id = #{productId}
        and reserve_id = #{reserveId}
        and status = 1
    </select>

    <update id="deleteProductReserve" parameterType="bo.ucb.edu.medichub.model.ProductReserve">
        UPDATE product_reserve set
            status = #{status},
            tx_id=#{transaction.txId},
            tx_host=#{transaction.txHost},
            tx_user_id=#{transaction.txUserId},
            tx_date=#{transaction.txDate}
        WHERE
            product_reserve_id=#{productReserveId}
          and status=1
    </update>



    <select id="productReserveListClient" resultMap="productReserveListClientMap">
        SELECT
        d.product_reserve_id as productId,
        b.name as brandName,
        a.name as name,
        d.quantity as quantity,
        a.price as price,
        a.type as type,
        a.dose as dose,
        a.description as description,
        a.picture as picture
        FROM product a, brand b, product_reserve d, reserve e
        WHERE
        a.brand_id = b.brand_id  and
        e.reserve_id = d.reserve_id and
        a.product_id = d.product_id and
        e.client_id=#{clientId} and
        <if test="name!='' ">
            a.name = #{name} and
        </if>
        e.reserve_id = #{reserveId}
        and d.status = 1
        ORDER BY a.name DESC
    </select>


    <select id="productSubsidiaryReserveListClient" resultMap="productReserveListClientMap">
        SELECT
        d.product_reserve_id as productId,
        b.name as brandName,
        a.name as name,
        d.quantity as quantity,
        a.price as price,
        a.type as type,
        a.dose as dose,
        a.description as description,
        a.picture as picture
        FROM product a, brand b, product_reserve d, reserve e, subsidiary f
        WHERE
        a.brand_id = b.brand_id  and
        e.reserve_id = d.reserve_id and
        a.product_id = d.product_id and
        f.subsidiary_id = a.subsidiary_id and
        e.reserve_id = #{reserveId}
        and f.subsidiary_id = #{subsidiaryId}
        and d.status = 1
        ORDER BY e.date DESC
    </select>

    <resultMap id="productReserveListClientMap" type="bo.ucb.edu.medichub.dto.ProductListResponse">
        <result column="productId" property="productId"/>
        <result column="brandName" property="brandName"/>
        <result column="name" property="name"/>
        <result column="quantity" property="quantity"/>
        <result column="price" property="price"/>
        <result column="type" property="type"/>
        <result column="dose" property="dose"/>
        <result column="description" property="description"/>
        <result column="picture" property="picture"/>
    </resultMap>

    <select id="getProductSubsidiary" resultMap="productReserveSubsidiaryListMap">
        SELECT d.reserve_id as reserveId,
	        d.date as date,
	        f.first_name as firstName,
            d.status_reserve as statusReserve
        FROM subsidiary a, product b, product_reserve c, reserve d, client e, person f
        WHERE
    	    a.subsidiary_id=b.subsidiary_id
            and b.product_id=c.product_id
            and d.reserve_id=c.reserve_id
            and e.client_id = d.client_id
            and f.person_id = e.person_id
            and a.subsidiary_id=#{subsidiaryId}
            <if test="state!=0 ">
                and d.status_reserve=#{state}
            </if>
            <if test="state==0 ">
                and d.status_reserve!=4
            </if>
        GROUP BY d.reserve_id
        ORDER BY d.date ASC
        LIMIT #{size} OFFSET #{page}
    </select>
    <resultMap id="productReserveSubsidiaryListMap" type="bo.ucb.edu.medichub.dto.ReserveSubsidiaryRequest">
        <result column="reserveId" property="reserveId"/>
        <result column="date" property="date"/>
        <result column="firstName" property="firstName"/>
        <result column="statusReserve" property="statusReserve"/>
    </resultMap>


    <select id="getProductSubsidiaryReport" resultMap="productReserveSubsidiaryReportListMap">
        SELECT d.reserve_id as reserveId,
	        d.date as date,
	        f.first_name as firstName
        FROM subsidiary a, product b, product_reserve c, reserve d, client e, person f
        WHERE
    	    a.subsidiary_id=b.subsidiary_id
            and b.product_id=c.product_id
            and d.reserve_id=c.reserve_id
            and e.client_id = d.client_id
            and f.person_id = e.person_id
            and a.subsidiary_id=#{subsidiaryId}
            and d.status_reserve=#{state}
        GROUP BY d.reserve_id
        ORDER BY d.date ASC
        LIMIT #{size} OFFSET #{page}
    </select>
    <resultMap id="productReserveSubsidiaryReportListMap" type="bo.ucb.edu.medichub.dto.ReserveSubsidiaryRequest">
        <result column="reserveId" property="reserveId"/>
        <result column="date" property="date"/>
        <result column="firstName" property="firstName"/>
    </resultMap>




    <select id="getProductSubsidiaryReportAsc" resultMap="productSubsidiaryReportListMap">
        SELECT
	        b.product_id as productId,
	        SUM(c.quantity) as quantity,
	        b.name as name,
	        b.price as price
        FROM subsidiary a, product b, product_reserve c, reserve d
        WHERE
    	    a.subsidiary_id=b.subsidiary_id
            and b.product_id=c.product_id
            and d.reserve_id=c.reserve_id
            and a.subsidiary_id=#{subsidiaryId}
            and d.status_reserve=3
        GROUP BY b.product_id
        ORDER BY d.date ASC
        LIMIT #{size} OFFSET #{page}
    </select>

    <select id="getProductSubsidiaryReportDesc" resultMap="productSubsidiaryReportListMap">
        SELECT
	        b.product_id as productId,
	        SUM(c.quantity) as quantity,
	        b.name as name,
	        b.price as price
        FROM subsidiary a, product b, product_reserve c, reserve d
        WHERE
    	    a.subsidiary_id=b.subsidiary_id
            and b.product_id=c.product_id
            and d.reserve_id=c.reserve_id
            and a.subsidiary_id=#{subsidiaryId}
            and d.status_reserve=3
        GROUP BY b.product_id
        ORDER BY d.date DESC
        LIMIT #{size} OFFSET #{page}
    </select>

    <resultMap id="productSubsidiaryReportListMap" type="bo.ucb.edu.medichub.dto.ProductReserveRepRequest">
        <result column="productId" property="productId"/>
        <result column="quantity" property="quantity"/>
        <result column="name" property="name"/>
        <result column="price" property="price"/>
    </resultMap>
</mapper>
