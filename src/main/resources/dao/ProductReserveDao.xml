<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bo.ucb.edu.medichub.dao.ProductReserveDao">
    <insert id="createProductReserve" parameterType="bo.ucb.edu.medichub.model.ProductReserve">
        INSERT INTO product_reserve VALUES (
            null, #{productId}, #{reserveId}, #{quantity},
            1, #{transaction.txId}, #{transaction.txHost}, #{transaction.txUserId}, #{transaction.txDate}
        )
    </insert>

    <update id="updateProductReserve" parameterType="bo.ucb.edu.medichub.model.ProductReserve">
        UPDATE product_reserve set
            quantity=#{quantity},
            tx_id=#{transaction.txId},
            tx_host=#{transaction.txHost},
            tx_user_id=#{transaction.txUserId},
            tx_date=#{transaction.txDate}
        WHERE
            product_id=#{productId}
        and reserve_id=#{reserveId}
        and status=1
    </update>

    <select id="getListProductReserve" resultMap="productReserveListMap">
        SELECT
        c.product_id as productId,
        c.name as name,
        c.price as price,
        b.quantity as quantity
        FROM product_reserve b, product c
        WHERE
        b.product_id = c.product_id and
        b.reserve_id = #{reserveId} and
        b.status = 1
        ORDER BY c.name DESC
    </select>
    <resultMap id="productReserveListMap" type="bo.ucb.edu.medichub.dto.ProductReserveRequest">
        <result column="productId" property="productId"/>
        <result column="name" property="name"/>
        <result column="price" property="price"/>
        <result column="quantity" property="quantity"/>
    </resultMap>


    <select id="productListClient" resultMap="productListClientMap">
        SELECT
        d.product_reserve_id as productId,
        b.name as brandName,
        a.name as name,
        d.quantity as quantity,
        a.price as price,
        a.type as type,
        a.dose as dose,
        a.description as description,
        a.picture as picture
        FROM product a, brand b, product_reserve d, reserve e
        WHERE
        a.brand_id = b.brand_id  and
        e.reserve_id = d.reserve_id and
        a.product_id = d.product_id and
        e.client_id=#{clientId} and
        e.status_reserve = #{state}
        and a.status = 1
        ORDER BY a.name DESC
        LIMIT #{size} OFFSET #{page}
    </select>
    <resultMap id="productListClientMap" type="bo.ucb.edu.medichub.dto.ProductListResponse">
        <result column="productId" property="productId"/>
        <result column="brandName" property="brandName"/>
        <result column="name" property="name"/>
        <result column="quantity" property="quantity"/>
        <result column="price" property="price"/>
        <result column="type" property="type"/>
        <result column="dose" property="dose"/>
        <result column="description" property="description"/>
        <result column="picture" property="picture"/>
    </resultMap>


    <select id="quantityProductReserve" resultType="java.lang.Integer">
        SELECT
            SUM(d.quantity) as quantity
        FROM product_reserve d, reserve e
        WHERE
            e.client_id=#{clientId} and
            e.status_reserve = 1 and
            e.reserve_id = d.reserve_id and
            d.status = 1
    </select>

    <select id="reserveProductReserve" resultMap="productReserveTotalMap">
        SELECT
        c.price as price,
        b.quantity as quantity
        FROM product_reserve b, product c, reserve e
        WHERE
        b.product_id = c.product_id and
        e.reserve_id = b.reserve_id and
        e.client_id=#{clientId} and
        b.status = 1
    </select>
    <resultMap id="productReserveTotalMap" type="bo.ucb.edu.medichub.dto.ProductReserveRequest">
        <result column="price" property="price"/>
        <result column="quantity" property="quantity"/>
    </resultMap>

    <select id="getProductReserveIfExists" resultType="java.lang.Integer">
        SELECT
            quantity
        FROM product_reserve
        WHERE
            product_id = #{productId}
        and reserve_id = #{reserveId}
        and status = 1
    </select>
</mapper>
