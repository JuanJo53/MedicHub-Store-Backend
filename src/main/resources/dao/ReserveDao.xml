<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="bo.ucb.edu.medichub.dao.ReserveDao">
    <insert id="createReserve" parameterType="bo.ucb.edu.medichub.model.Reserve">
        INSERT INTO reserve VALUES (
            null, #{clientId}, #{date}, #{statusReserve},
            1, #{transaction.txId}, #{transaction.txHost}, #{transaction.txUserId}, #{transaction.txDate}
        )
    </insert>


    <select id="getListReserve" resultMap="reserveListMap">
        SELECT
        a.reserve_id as reserveId,
        a.client_id as clientId
        FROM reserve a
        WHERE
        a.status = 1
        and a.status_reserve = #{state}
        ORDER BY a.date DESC
        LIMIT #{size} OFFSET #{page}
    </select>


    <resultMap id="reserveListMap" type="bo.ucb.edu.medichub.dto.ReserveRequest">
        <result column="reserveId" property="reserveId"/>
        <result column="clientId" property="clientId"/>
    </resultMap>


    <select id="getLastReserveStatus" resultType="java.lang.Integer">
        SELECT
            status_reserve
        FROM reserve
        WHERE
            client_id = #{clientId}
        and status = 1
        and reserve_id = (SELECT MAX(reserve_id) FROM reserve WHERE client_id = #{clientId})
    </select>




    <select id="getLastReserveId" resultType="java.lang.Integer">
        SELECT
            MAX(reserve_id)
        FROM reserve
        WHERE
            client_id = #{clientId}
          and status = 1
    </select>


    <select id="getReserveId" resultType="java.lang.Integer">
       SELECT
        a.reserve_id as reserveId
        FROM reserve a
        WHERE
        a.status = 1
        and a.client_id = #{clientId}
        and a.status_reserve = #{state}
    </select>


    <update id="updateReserveStatus" parameterType="bo.ucb.edu.medichub.model.Reserve">
        UPDATE reserve set
            status_reserve = #{statusReserve},
            tx_id=#{transaction.txId},
            tx_host=#{transaction.txHost},
            tx_user_id=#{transaction.txUserId},
            tx_date=#{transaction.txDate}
        WHERE
            reserve_id=#{reserveId}
        and client_id=#{clientId}
        and status=1
    </update>

    <update id="updateReserve" parameterType="bo.ucb.edu.medichub.model.Reserve">
        UPDATE reserve set
            status_reserve=#{statusReserve},
            tx_id=#{transaction.txId},
            tx_host=#{transaction.txHost},
            tx_user_id=#{transaction.txUserId},
            tx_date=#{transaction.txDate}
        WHERE
            reserve_id=#{reserveId}
          and status=1
    </update>
    <update id="deleteClientReserve" parameterType="bo.ucb.edu.medichub.model.Reserve">
        UPDATE reserve set
            status_reserve=#{statusReserve},
            tx_id=#{transaction.txId},
            tx_host=#{transaction.txHost},
            tx_user_id=#{transaction.txUserId},
            tx_date=#{transaction.txDate}
        WHERE
            reserve_id=#{reserveId}
          and status=1
    </update>




    <select id="getReserveClient" resultMap="reserveClientListMap">
        SELECT
        a.reserve_id as reserveId,
        a.date as dateReserve
        FROM reserve a
        WHERE
        a.status = 1
        and a.status_reserve = #{state}
        and a.client_id = #{clientId}
        and a.date between #{ini} and #{end}
        ORDER BY a.date DESC
    </select>

    <resultMap id="reserveClientListMap" type="bo.ucb.edu.medichub.dto.ReserveListRequest">
        <result column="reserveId" property="reserveId"/>
        <result column="dateReserve" property="dateReserve"/>
    </resultMap>
</mapper>
